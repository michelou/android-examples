<?xml version="1.0" encoding="UTF-8"?>
<project name="build-scala">

    <!-- This file is imported by the main Ant script. -->

    <property name="configs.dir" value="${basedir}/configs" />
    <property name="shrinked.jar" location="${out.absolute.dir}/shrinked.jar" />

    <!-- Scala (www.scala-lang.org) -->
    <property name="scala-compiler.jar" value="${scala.dir}/lib/scala-compiler.jar" />
    <property name="scala-library.jar" value="${scala.dir}/lib/scala-library.jar" />

    <!-- Rules -->

    <resourcecount property="scala.files.count">
        <fileset dir="${source.dir}" includes="**/*.scala" />
    </resourcecount>
    <condition property="contains.scala.sources">
        <not><equals arg1="${scala.files.count}" arg2="0" /></not>
    </condition>

    <target name="compile-scala" depends="compile"
        if="contains.scala.sources" unless="do.not.compile"
        description="Compiles project's .scala files into .class files">
        <path id="scala.path">
            <pathelement path="${scala-compiler.jar}" />
            <pathelement path="${scala-library.jar}" />
        </path>
        <taskdef resource="scala/tools/ant/antlib.xml" classpathref="scala.path" />

        <condition property="logging" value="verbose" else="none">
            <istrue value="${verbose}" />
        </condition>
        <property prefix="scala"
            resource="compiler.properties"
            classpathref="scala.path" />
        <echo
            message="Scala version ${scala.version.number} - http://scala-lang.org"
            level="info" taskname="scalac" />
        <scalac
            destdir="${out.classes.absolute.dir}"
            bootclasspathref="android.target.classpath"
            logging="${logging}" addparams="${scalac.addparams}"
            classpath="${extensible.classpath}"
            classpathref="jar.libs.ref">
            <src path="${source.absolute.dir}" />
            <src path="${gen.absolute.dir}" />
            <src refid="project.libraries.src" />
            <classpath>
                <pathelement location="${scala-library.jar}" />
                <!-- include compiled resources -->
                <pathelement location="${out.classes.absolute.dir}" />
                <fileset dir="${extensible.libs.classpath}" includes="*.jar" />
            </classpath>
        </scalac>
    </target>

    <target name="-pre-shrink-scala">
        <if condition="${build.mode.release}"><then>
            <!-- needed for obfuscate task -->
            <path id="project.libraries.jars">
                <pathelement location="${scala-library.jar}" />
            </path>
        </then><else>
            <condition property="shrink.required"><not>
                <uptodate targetfile="${shrinked.jar}">
                    <srcfiles dir="${source.absolute.dir}" includes="**/*.scala" />
                </uptodate>
            </not></condition>
            <!-- input for dex will be proguard's output -->
            <property name="out.dex.input.absolute.dir" value="${shrinked.jar}" />        
        </else></if>
    </target>

	<target name="-shrink-scala" depends="-pre-shrink-scala"
	        if="shrink.required" unless="do.not.compile"
	        description="Shrink project class files and Scala library into one .jar file">
        <!-- add Proguard tasks (proguard.sourceforge.net) -->
        <property name="proguard.jar" location="${proguard.dir}/lib/proguard.jar" />
        <taskdef name="proguard" classname="proguard.ant.ProGuardTask" classpath="${proguard.jar}" />

        <condition property="shrink.mode" value="-release" else="-debug">
           <isset property="build.mode.release" />
        </condition>
        <!-- priority is given to local ProGuard configuration if present -->
        <condition property="template.cfg" value="${configs.dir}/local${shrink.mode}.cfg">
            <available file="${configs.dir}/local${shrink.mode}.cfg" />
        </condition>
        <condition property="template.cfg" value="${configs.dir}/default${shrink.mode}.cfg">
            <available file="${configs.dir}/default${shrink.mode}.cfg" />
        </condition>
        <fail message="Template file '${template.cfg}' not found">
            <condition><not><available file="${template.cfg}" /></not></condition>
        </fail>
        <property name="shrink-proguard.cfg" value="${out.absolute.dir}${file.separator}shrink${shrink.mode}.cfg" />
        <echo message="Generating configuration file ${shrink-proguard.cfg}" />
        <generate-header property="header" />
        <!-- set the compiled project files and Scala library into a single property. -->
        <pathconvert property="project.injars">
            <path location="${out.classes.absolute.dir}" />
            <path location="${scala-library.jar}(!META-INF/MANIFEST.MF,!library.properties)" />
        </pathconvert>
        <split-path property="injars" prefix="-injars" path="${project.injars}" />
        <split-path property="outjars" prefix="-outjars" path="${shrinked.jar}" />
        <!-- set the android classpath object into a single property. -->
        <pathconvert property="project.libraryjars">
            <fileset dir="${jar.libs.dir}" includes="*.jar" />
            <path refid="android.target.classpath" />
        </pathconvert>
        <split-path property="libraryjars" prefix="-libraryjars" path="${project.libraryjars}" />
        <copy file="${template.cfg}" tofile="${shrink-proguard.cfg}">
            <filterchain>
                <replacetokens>
                    <token key="HEADER" value="${header}" />
                    <token key="INJARS" value="${injars}" />
                    <token key="OUTJARS" value="${outjars}" />
                    <token key="LIBRARYJARS" value="${libraryjars}" />
                    <token key="PACKAGENAME" value="${manifest.package}.**" />
                </replacetokens>
            </filterchain>
        </copy>
        <proguard configuration="${shrink-proguard.cfg}" />
    </target>

    <target name="install-release" depends="release"
            description="Installs/reinstalls the release package onto a running
                         emulator or device. If the application was previously
                         installed, the signatures must match." >
        <install-release-helper />
    </target>

    <!-- Macros -->

    <macrodef name="install-release-helper">
        <sequential>
            <echo>Installing ${out.release.file} onto default emulator or device...</echo>
            <exec executable="${adb}" failonerror="true">
                <arg line="${adb.device.arg}" />
                <arg value="install" />
                <arg value="-r" />
                <arg path="${out.release.file}" />
            </exec>
        </sequential>
    </macrodef>

    <macrodef name="generate-header">
        <attribute name="property" />
        <sequential>
            <dirname property="parentdir" file="${basedir}" />
            <pathconvert property="rel.template.cfg">
                <map from="${parentdir}${file.separator}" to="" />
                <path location="${template.cfg}" />
            </pathconvert>
            <property name="@{property}" value="# This file is automatically generated from ${rel.template.cfg}" />
        </sequential>
    </macrodef>

    <!-- split 'path' into several lines starting with 'prefix' and save result in 'property' -->
    <macrodef name="split-path">
        <attribute name="property" />
        <attribute name="prefix" />
        <attribute name="path" />
        <sequential>
            <tempfile property="temp.file" destdir="${out.dir}" deleteonexit="true" />
            <echo message="@{path}" file="${temp.file}" />
            <loadfile srcfile="${temp.file}" property="@{property}.list">
                <filterchain>
                    <replacestring from="${path.separator}" to="${line.separator}"/>
                    <replaceregex pattern="(.*)" replace="@{prefix} \1" />
                </filterchain>
            </loadfile>
            <property name="@{property}" value="${@{property}.list}" />
        </sequential>
    </macrodef>

</project>
